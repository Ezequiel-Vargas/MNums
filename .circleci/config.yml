version: 2.1

orbs:
  python: circleci/python@3.0.0

executors:
  my-executor:
    docker:
      - image: cimg/python:3.12
    working_directory: ~/repo

jobs:
  checkout_code:
    executor: my-executor
    steps:
      - checkout
      - run:
          name: Show python and pip
          command: |
            python --version
            pip --version

  install_deps:
    executor: my-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
            - v1-dependencies-
      - run:
          name: Crear venv e instalar requirements
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
      - persist_to_workspace:
          root: ~/repo
          paths:
            - venv

  run_tests:
    executor: my-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Ejecutar migrations
          command: |
            . venv/bin/activate
            export DJANGO_SETTINGS_MODULE=MNums.settings
            python manage.py migrate --noinput || true
      - run:
          name: Ejecutar tests si existen
          command: |
            . venv/bin/activate
            if git ls-files | grep -E '(^|/)tests?(/|$)|(^|/)test_.*\.py' >/dev/null 2>&1; then
              python manage.py test --verbosity=2
            else
              echo "No tests found, skipping."
            fi

  build_artifact:
    executor: my-executor
    steps:
      - checkout
      - run:
          name: Crear zip de release
          command: |
            git rev-parse --short HEAD > VERSION.txt || true
            zip -r release-$(cat VERSION.txt).zip . -x ".git/*" "venv/*" ".circleci/*"
      - store_artifacts:
          path: release-*.zip
          destination: release-zip
      - persist_to_workspace:
          root: ~/repo
          paths:
            - release-*.zip
            - VERSION.txt

  create_github_release_and_upload:
    executor: my-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Crear release en GitHub y subir zip
          command: |
            set -e
            TAG="ci-$(git rev-parse --short HEAD)"
            BODY="Release creada por pipeline de CircleCI."
            OWNER_REPO="Ezequiel-Vargas/MNums"
            
            RESP=$(curl -s -X POST \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -d "{\"tag_name\":\"${TAG}\",\"name\":\"${TAG}\",\"body\":\"${BODY}\",\"prerelease\":true}" \
              https://api.github.com/repos/${OWNER_REPO}/releases)
            
            UPLOAD_URL=$(echo "$RESP" | python -c "import sys, json; print(json.load(sys.stdin).get('upload_url','').split('{')[0])")
            
            if [ -z "$UPLOAD_URL" ]; then 
              echo "Failed to create release: $RESP"
              exit 1
            fi
            
            curl -s -X POST \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Content-Type: application/zip" \
              --data-binary @release-$(cat VERSION.txt).zip \
              "${UPLOAD_URL}?name=release-$(cat VERSION.txt).zip"

  deploy_simulated:
    executor: my-executor
    steps:
      - checkout
      - run:
          name: Deploy simulado
          command: |
            echo "Simulaci√≥n de despliegue"
            echo "Script de despliegue."
            echo "Se ha aprobado la release y se ejecuta el deploy simulado."

workflows:
  version: 2
  ci_pipeline:
    jobs:
      - checkout_code
      - install_deps:
          requires:
            - checkout_code
      - run_tests:
          requires:
            - install_deps
      - build_artifact:
          requires:
            - run_tests
      - create_github_release_and_upload:
          requires:
            - build_artifact
      - hold_for_approval:
          type: approval
          requires:
            - create_github_release_and_upload
      - deploy_simulated:
          requires:
            - hold_for_approval
